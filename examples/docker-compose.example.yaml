# --------------------------------------------------------------------
# DSMR Reader + PostgreSQL (Docker / Podman Compose)
# --------------------------------------------------------------------

services:
  # ------------------------------------------------------------
  # PostgreSQL database for DSMR Reader
  # ------------------------------------------------------------
  dsmrdb:
    image: postgres:17-alpine
    container_name: dsmrdb

    # Automatically restart unless explicitly stopped
    restart: unless-stopped

    # Timezone configuration
    environment:
      TZ: Europe/Amsterdam
      PG_TZ: Europe/Amsterdam

      # Database initialization
      POSTGRES_DB: dsmrreader
      POSTGRES_USER: dsmrreader
      POSTGRES_PASSWORD: dsmrreader

    # Persistent database storage
    volumes:
      - dsmrdb_data:/var/lib/postgresql/data

    # Internal network
    networks:
      - dsmrnet

  # ------------------------------------------------------------
  # DSMR Reader application
  # ------------------------------------------------------------
  dsmr:
    image: ghcr.io/xirixiz/dsmr-reader-docker:6
    container_name: dsmr

    # Automatically restart unless explicitly stopped
    restart: unless-stopped

    # Ensure database container is started first
    depends_on:
      - dsmrdb

    # s6-overlay requires executable tmpfs mounts
    tmpfs:
      - /run:rw,exec,nosuid,nodev,size=64m
      - /tmp:rw,exec,nosuid,nodev,size=256m

    # Expose HTTP and HTTPS ports
    ports:
      - "7777:80"
      - "7779:443"

    # Persistent backups directory
    volumes:
      - dsmr_backups:/app/backups

    # Application configuration
    environment:
      # Timezone
      TZ: Europe/Amsterdam
      DJANGO_TIME_ZONE: Europe/Amsterdam

      # DSMR Reader operantion mode
      DSMRREADER_OPERATION_MODE: standalone

      # Database connection
      DJANGO_DATABASE_HOST: dsmrdb
      DJANGO_DATABASE_PORT: 5432
      DJANGO_DATABASE_NAME: dsmrreader
      DJANGO_DATABASE_USER: dsmrreader
      DJANGO_DATABASE_PASSWORD: dsmrreader

      # Django / DSMR credentials
      DJANGO_SECRET_KEY: dsmrreader
      DSMRREADER_ADMIN_USER: admin
      DSMRREADER_ADMIN_PASSWORD: admin

      # Optional maintenance
      ENABLE_VACUUM_DB_ON_STARTUP: true

      # File-based secret injection (s6-overlay)
      FILE__SECRET: /run/secrets/a_secret_file

    # Docker / Podman secrets
    secrets:
      - a_secret_file

    # Serial device mapping for P1 meter
    devices:
      - "/dev/ttyUSB1:/dev/ttyUSB0"

    # Basic container hardening
    security_opt:
      - no-new-privileges:true

    # Internal network
    networks:
      - dsmrnet

# --------------------------------------------------------------------
# Networks
# --------------------------------------------------------------------

networks:
  dsmrnet:
    name: dsmrnet

# --------------------------------------------------------------------
# Secrets
# --------------------------------------------------------------------

secrets:
  a_secret_file:
    file: ./somedir/my_secret.txt

# --------------------------------------------------------------------
# Volumes
# --------------------------------------------------------------------

volumes:
  dsmrdb_data:
  dsmr_backups:
