name: 'build multi arch images for DSMR Reader'

on:
  push:
    branches:
      - 's6_init'
  pull_request:
    branches:
      - 'master'
    paths-ignore:
      - '**.md'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # DOCKER_BUILDKIT: 1
      # DOCKER_CLI_EXPERIMENTAL: enabled
      DOCKER_BASE_IMAGE: python:3-alpine3.13
      DOCKER_TARGET_REPO: xirixiz/dsmr-reader-docker
      BUILD_IMAGE_NAME: local/alpine-base
      DOCKERFILE: Dockerfile
    strategy:
      matrix:
        include:
          # AMD64
          - BASE_IMAGE: amd64/${DOCKER_BASE_IMAGE}
            QEMU_ARCH: x86_64
            S6_ARCH: amd64
            DOCKER_TAG_SUFFIX: amd64

          # ARM32V6
          - BASE_IMAGE: arm32v6/${DOCKER_BASE_IMAGE}
            QEMU_ARCH: arm
            S6_ARCH: armhf
            DOCKER_TAG_SUFFIX: arm32v6

          # ARM32V7
          - BASE_IMAGE: arm32v6/${DOCKER_BASE_IMAGE}
            QEMU_ARCH: arm
            S6_ARCH: armhf
            DOCKER_TAG_SUFFIX: arm32v7

          # ARM64V8
          - BASE_IMAGE: arm64v8/${DOCKER_BASE_IMAGE}
            QEMU_ARCH: aarch64
            S6_ARCH: aarch64
            DOCKER_TAG_SUFFIX: arm64v8

    steps:
    ################################################
    ## GENERAL
    ################################################
    - name: 'üöÄ GitHub - Checkout repository'
      uses: actions/checkout@v2

    - name: 'üöÄ GitHub - Get Branch / Tag Name'
      id: get_branch
      run: |
        export RELEASE_NAME=$(if [[ "${GITHUB_REF}" =~ "refs/tags/" ]]; \
          then echo ${GITHUB_REF/refs\/tags\//}; \
          else echo ${GITHUB_REF/refs\/heads\//}; fi)
        echo "${RELEASE_NAME}"
        echo ::set-output name=NAME::${RELEASE_NAME}

    - name: 'üöÄ GitHub - Get Tag'
      id: get_tag
      run: |
        export TARGET_IMAGE_TAG=$(if [ "${{ steps.get_branch.outputs.name }}" = "master" ]; \
          then echo "${{ matrix.DOCKER_TAG_SUFFIX }}"; \
          else echo "${{ matrix.DOCKER_TAG_SUFFIX }}-${{ steps.get_branch.outputs.name }}"; \
          fi;)
        echo "${TARGET_IMAGE_TAG}"
        echo ::set-output name=NAME::${TARGET_IMAGE_TAG}

    ################################################
    ## QEMU
    ################################################
    - name: '‚öôÔ∏è QEMU - Determine version'
      id: qemu_version
      shell: bash
      run: |
        URL='https://api.github.com/repos/multiarch/qemu-user-static/releases/latest'
        VERSION=$(curl -SskLf "${URL}" | jq -r '.tag_name')
        VERSION=${VERSION#"v"}
        echo "::set-output name=version::${VERSION}"

    - name: 'üöÄ QEMU - Get package'
      env:
        qemu_version: ${{ steps.qemu_version.outputs.version }}
      run: |
        docker run --rm --privileged multiarch/qemu-user-static:register --reset
        mkdir -p tmp/qemu
        curl -SskLf "https://github.com/multiarch/qemu-user-static/releases/download/v${qemu_version}/qemu-${{ matrix.QEMU_ARCH }}-static.tar.gz" | tar xvzf - -C tmp/qemu

    ################################################
    ## S6
    ################################################
    - name: '‚öôÔ∏è S6 - Determine version'
      id: s6_version
      shell: bash
      run: |
        URL='https://api.github.com/repos/just-containers/s6-overlay/releases/latest'
        VERSION=$(curl -SskLf "${URL}" | jq -r '.tag_name')
        VERSION=${VERSION#"v"}
        echo "::set-output name=version::${VERSION}"

    - name: 'üöÄ S6 - Get package'
      env:
        s6_version: ${{ steps.s6_version.outputs.version }}
      run: |
        mkdir -p tmp/s6-${{ matrix.S6_ARCH }}
        curl -SskLf "https://github.com/just-containers/s6-overlay/releases/download/v${s6_version}/s6-overlay-${{ matrix.S6_ARCH }}.tar.gz" | tar xvzf - -C tmp/s6-${{ matrix.S6_ARCH }}

    ################################################
    ## DSMR
    ################################################
    - name: '‚öôÔ∏è DSMR - Determine version'
      id: dsmr_version
      shell: bash
      run: |
        URL='https://api.github.com/repos/dsmrreader/dsmr-reader/releases/latest'
        VERSION=$(curl -SskLf "${URL}" | jq -r '.tag_name')
        VERSION=${VERSION#"v"}
        echo "::set-output name=version::${VERSION}"

    - name: 'üöÄ DSMR - Get package'
      env:
        dsmr_version: ${{ steps.dsmr_version.outputs.version }}
      run: |
        mkdir -p tmp/dsmr
        curl -SskLf "https://github.com/dsmrreader/dsmr-reader/archive/v${dsmr_version}.tar.gz" | tar xvzf - --strip-components=1 -C tmp/dsmr
        pushd tmp/dsmr &&
        curl -SskLf "https://raw.githubusercontent.com/dsmrreader/dsmr-reader/v4/dsmr_datalogger/scripts/dsmr_datalogger_api_client.py" -O &&
        popd

    ################################################
    ## Docker
    ################################################
    - name: 'üîì Docker - Login'
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: 'üöÄ Docker - Build'
      env:
        TARGET_IMAGE: ${DOCKER_TARGET_REPO}
      run: |
        export DOCKER_TAG_SUFFIX_BRANCH=$(if [ "${{ steps.get_branch.outputs.name }}" = "master" ]; then echo ""; else echo "-${{ steps.get_branch.outputs.name }}"; fi)

        echo "DOCKER BUILD: Build Docker image."
        echo "DOCKER BUILD: base image - ${{matrix.BASE_IMAGE}}."
        echo "DOCKER BUILD: s6 -> ${{matrix.S6_ARCH}}."
        echo "DOCKER BUILD: s6 version -> ${{ steps.s6_version.outputs.version }}."
        echo "DOCKER BUILD: qemu version -> ${{ steps.qemu_version.outputs.version }}."
        echo "DOCKER BUILD: qemu arch - ${{matrix.QEMU_ARCH}}."
        echo "DOCKER BUILD: dsmr version -> ${{ steps.dsmr_version.outputs.version }}."
        echo "DOCKER BUILD: docker file - ${DOCKERFILE}."
        echo "DOCKER BUILD: tag suffix - ${{ matrix.DOCKER_TAG_SUFFIX }}."
        echo "DOCKER BUILD: target image - ${TARGET_IMAGE}."
        echo "DOCKER BUILD: tag suffix branch - ${DOCKER_TAG_SUFFIX_BRANCH}."

        docker build -f ${DOCKERFILE} \
          --build-arg BASE_IMAGE=${{ matrix.BASE_IMAGE }} \
          --build-arg QEMU_ARCH=${{ matrix.QEMU_ARCH }} \
          --build-arg S6_ARCH=${{ matrix.S6_ARCH }} \
          -t ${TARGET_IMAGE}:${{ matrix.DOCKER_TAG_SUFFIX }}${DOCKER_TAG_SUFFIX_BRANCH} \
          .

    - name: 'üöÄ Docker - Push'
      env:
        TARGET_IMAGE: ${DOCKER_TARGET_REPO}
      run: |
        export DOCKER_TAG_SUFFIX_BRANCH=$(if [ "${{ steps.get_branch.outputs.name }}" = "master" ]; then echo ""; else echo "-${{ steps.get_branch.outputs.name }}"; fi)
        docker push ${TARGET_IMAGE}:${{ matrix.DOCKER_TAG_SUFFIX }}${DOCKER_TAG_SUFFIX_BRANCH}

    - name: 'üõ∞Ô∏è Docker - Publish Manifest'
      env:
        TARGET_IMAGE: ${DOCKER_TARGET_REPO}
      run: |
        export MANIFEST_SUFFIX=$(if [ "${{ steps.get_branch.outputs.name }}" = "master" ]; then echo "latest"; else echo "${{ steps.get_branch.outputs.name }}"; fi)
        export DOCKER_TAG_SUFFIX_BRANCH=$(if [ "${{ steps.get_branch.outputs.name }}" = "master" ]; then echo ""; else echo "-${{ steps.get_branch.outputs.name }}"; fi)

        docker manifest create "${TARGET_IMAGE}:${MANIFEST_SUFFIX}" \
          "${TARGET_IMAGE}:amd64${DOCKER_TAG_SUFFIX_BRANCH}" \
          "${TARGET_IMAGE}:arm32v6${DOCKER_TAG_SUFFIX_BRANCH}" \
          "${TARGET_IMAGE}:arm32v7${DOCKER_TAG_SUFFIX_BRANCH}" \
          "${TARGET_IMAGE}:arm64v8${DOCKER_TAG_SUFFIX_BRANCH}"

        docker manifest annotate "${TARGET_IMAGE}:${MANIFEST_SUFFIX}" "${TARGET_IMAGE}:arm32v6${DOCKER_TAG_SUFFIX_BRANCH}" --os=linux --arch=arm --variant=v6
        docker manifest annotate "${TARGET_IMAGE}:${MANIFEST_SUFFIX}" "${TARGET_IMAGE}:arm32v7${DOCKER_TAG_SUFFIX_BRANCH}" --os=linux --arch=arm --variant=v7
        docker manifest annotate "${TARGET_IMAGE}:${MANIFEST_SUFFIX}" "${TARGET_IMAGE}:arm64v8${DOCKER_TAG_SUFFIX_BRANCH}" --os=linux --arch=arm64 --variant=v8
        docker manifest push "${TARGET_IMAGE}:${MANIFEST_SUFFIX}"