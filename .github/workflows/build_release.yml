name: "DSMR: Build Docker images"

on:
  workflow_dispatch:
    inputs:
      dsmr_version:
        description: "Optional DSMR Reader version (e.g. v6.0rc7, 6.0rc7, 6.0.0). Leave empty to auto-detect."
        required: false
        default: ""

concurrency:
  group: docker-build
  cancel-in-progress: true

env:
  DOCKER_TARGET_REPO: xirixiz/dsmr-reader-docker
  DOCKERFILE: Dockerfile

jobs:
  build_release:
    runs-on: ubuntu-latest

    steps:
      - name: "üöÄ GitHub: Checkout repository"
        uses: actions/checkout@v4

      - name: "‚öôÔ∏è DSMR: Determine upstream version"
        id: dsmr_version
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF##*/}"
          INPUT_VERSION="${{ github.event.inputs.dsmr_version }}"
          REPO_VAR="${{ vars.DSMR_VERSION }}"

          echo "Branch=${BRANCH}"
          echo "Workflow input dsmr_version='${INPUT_VERSION}'"
          echo "Repository variable DSMR_VERSION='${REPO_VAR}'"

          # 1. development branch ‚Üí always development
          if [[ "${BRANCH}" == "development" ]]; then
            echo "development branch detected ‚Üí forcing version=development"
            echo "version=development" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 2. Manual workflow input (main only)
          if [[ -n "${INPUT_VERSION}" ]]; then
            VERSION="${INPUT_VERSION#v}"
            echo "Using manual workflow input DSMR_VERSION=${VERSION}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 3. Repository variable
          if [[ -n "${REPO_VAR}" ]]; then
            VERSION="${REPO_VAR#v}"
            echo "Using repository DSMR_VERSION=${VERSION}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 4. Default: latest upstream release
          URL="https://api.github.com/repos/dsmrreader/dsmr-reader/releases/latest"
          VERSION="$(curl -fsSL "${URL}" | jq -r '.tag_name' | sed 's/^v//')"
          echo "Using latest upstream release=${VERSION}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: "‚öôÔ∏è Docker: Compute Docker build release"
        id: docker_release
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF##*/}"

          if [[ "${BRANCH}" == "main" ]]; then
            DATE="$(TZ=Europe/Amsterdam date +%Y%m%d)"
            RUN="${GITHUB_RUN_NUMBER}"
            REL="${DATE}.${RUN}"
          else
            REL="development"
          fi

          echo "release=${REL}" >> "$GITHUB_OUTPUT"
          echo "DOCKER_TARGET_RELEASE=${REL}" >> "$GITHUB_ENV"
          echo "Computed DOCKER_TARGET_RELEASE=${REL}"

      - name: "‚öôÔ∏è Docker: Compute tags"
        id: docker_tags
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ steps.dsmr_version.outputs.version }}"
          BRANCH="${GITHUB_REF##*/}"

          if [[ "${BRANCH}" == "development" ]]; then
            {
              echo "tags<<EOF"
              echo "development"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${VERSION}" == "development" ]]; then
            echo "Main branch cannot publish 'development' as version" >&2
            exit 1
          fi

          MAJOR="$(echo "${VERSION}" | cut -d. -f1)"
          MINOR="$(echo "${VERSION}" | cut -d. -f2)"

          if [[ -z "${MAJOR}" || -z "${MINOR}" ]]; then
            echo "Version '${VERSION}' does not look like x.y.z (or x.y...), refusing to tag" >&2
            exit 1
          fi

          {
            echo "tags<<EOF"
            echo "${VERSION}"
            echo "${MAJOR}.${MINOR}"
            echo "${MAJOR}"
            echo "latest"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: "‚öôÔ∏è Docker: Set up QEMU"
        uses: docker/setup-qemu-action@v3

      - name: "‚öôÔ∏è Docker: Set up Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "üîì Docker: Login (Docker Hub)"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: "üîì Docker: Login (GHCR)"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "‚öôÔ∏è Docker: Metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKER_TARGET_REPO }}
            ghcr.io/${{ env.DOCKER_TARGET_REPO }}
          tags: ${{ steps.docker_tags.outputs.tags }}

      - name: "üöÄ Docker: Build and push"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |-
            DSMR_VERSION=${{ steps.dsmr_version.outputs.version }}
            DOCKER_TARGET_RELEASE=${{ steps.docker_release.outputs.release }}
