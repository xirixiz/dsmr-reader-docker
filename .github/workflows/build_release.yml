name: "DSMR: Build Docker images"

on:
  workflow_dispatch:
    inputs:
      dsmr_version:
        description: "Optional DSMR Reader version (e.g. v6.0rc7, 6.0rc7, 6.0.0). Leave empty to auto-detect."
        required: false
        default: ""
      architectures:
        description: "Target architectures (comma-separated: amd64,arm64,armv7). Leave empty for all."
        required: false
        default: ""

concurrency:
  group: docker-build
  cancel-in-progress: true

env:
  DOCKER_TARGET_REPO: xirixiz/dsmr-reader-docker
  DOCKERFILE: Dockerfile
  DEFAULT_PLATFORMS: linux/amd64,linux/arm64,linux/arm/v7

jobs:
  build_release:
    runs-on: ubuntu-latest

    steps:
      - name: "üöÄ GitHub: Checkout repository"
        uses: actions/checkout@v4

      ################################################
      # DETECT BRANCH + INPUT GUARD
      ################################################
      - name: "üîç Determine branch + sanitize inputs"
        id: branch_guard
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF##*/}"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"

          if [[ "${BRANCH}" != "development" ]]; then
            echo "‚ö†Ô∏è Not on development branch ‚Äî ignoring workflow_dispatch inputs."
            echo "use_inputs=false" >> "$GITHUB_OUTPUT"
          else
            echo "use_inputs=true" >> "$GITHUB_OUTPUT"
          fi

      ################################################
      # DSMR VERSION RESOLUTION
      ################################################
      - name: "‚öôÔ∏è DSMR: Determine upstream version"
        id: dsmr_version
        shell: bash
        run: |
          set -euo pipefail

          USE_INPUTS="${{ steps.branch_guard.outputs.use_inputs }}"
          BRANCH="${{ steps.branch_guard.outputs.branch }}"
          INPUT_VERSION="${{ github.event.inputs.dsmr_version }}"
          REPO_VAR="${{ vars.DSMR_VERSION }}"

          if [[ "${BRANCH}" == "development" ]]; then
            echo "version=development" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${USE_INPUTS}" == "true" && -n "${INPUT_VERSION}" ]]; then
            echo "version=${INPUT_VERSION#v}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ -n "${REPO_VAR}" ]]; then
            echo "version=${REPO_VAR#v}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          VERSION="$(curl -fsSL https://api.github.com/repos/dsmrreader/dsmr-reader/releases/latest \
            | jq -r '.tag_name' | sed 's/^v//')"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      ################################################
      # DOCKER RELEASE VERSION
      ################################################
      - name: "‚öôÔ∏è Docker: Compute Docker build release"
        id: docker_release
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${{ steps.branch_guard.outputs.branch }}"

          if [[ "${BRANCH}" == "main" ]]; then
            DATE="$(TZ=Europe/Amsterdam date +%Y%m%d)"
            REL="${DATE}.${GITHUB_RUN_NUMBER}"
          else
            REL="development"
          fi

          echo "release=${REL}" >> "$GITHUB_OUTPUT"
          echo "DOCKER_TARGET_RELEASE=${REL}" >> "$GITHUB_ENV"

      ################################################
      # ARCHITECTURE SELECTION
      ################################################
      - name: "‚öôÔ∏è Docker: Determine platforms"
        id: docker_platforms
        shell: bash
        run: |
          set -euo pipefail

          USE_INPUTS="${{ steps.branch_guard.outputs.use_inputs }}"
          INPUT="${{ github.event.inputs.architectures }}"

          if [[ "${USE_INPUTS}" != "true" || -z "${INPUT}" ]]; then
            PLATFORMS="${DEFAULT_PLATFORMS}"
          else
            PLATFORMS=""
            IFS=',' read -ra ARCHES <<< "${INPUT}"
            for ARCH in "${ARCHES[@]}"; do
              case "${ARCH}" in
                amd64) PLATFORMS+=",linux/amd64" ;;
                arm64) PLATFORMS+=",linux/arm64" ;;
                armv7) PLATFORMS+=",linux/arm/v7" ;;
                *)
                  echo "Unsupported architecture: ${ARCH}" >&2
                  exit 1
                  ;;
              esac
            done
            PLATFORMS="${PLATFORMS#,}"
          fi

          echo "platforms=${PLATFORMS}" >> "$GITHUB_OUTPUT"
          echo "Using platforms: ${PLATFORMS}"

      ################################################
      # TAG COMPUTATION
      ################################################
      - name: "‚öôÔ∏è Docker: Compute tags"
        id: docker_tags
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ steps.dsmr_version.outputs.version }}"
          BRANCH="${{ steps.branch_guard.outputs.branch }}"

          if [[ "${BRANCH}" == "development" ]]; then
            {
              echo "tags<<EOF"
              echo "development"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MAJOR="$(echo "${VERSION}" | cut -d. -f1)"
          MINOR="$(echo "${VERSION}" | cut -d. -f2)"

          {
            echo "tags<<EOF"
            echo "${VERSION}"
            echo "${MAJOR}.${MINOR}"
            echo "${MAJOR}"
            echo "latest"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      ################################################
      # DOCKER BUILD
      ################################################
      - name: "‚öôÔ∏è Docker: Set up QEMU"
        uses: docker/setup-qemu-action@v3

      - name: "‚öôÔ∏è Docker: Set up Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "üîì Docker: Login (Docker Hub)"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: "üîì Docker: Login (GHCR)"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "‚öôÔ∏è Docker: Metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKER_TARGET_REPO }}
            ghcr.io/${{ env.DOCKER_TARGET_REPO }}
          tags: ${{ steps.docker_tags.outputs.tags }}
          labels: |
            org.opencontainers.image.title=DSMR Reader Docker
            org.opencontainers.image.description=Containerized DSMR Reader build
            org.opencontainers.image.version=${{ steps.dsmr_version.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.created=${{ steps.docker_release.outputs.release }}
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}/README.md

      - name: "üöÄ Docker: Build and push"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          platforms: ${{ steps.docker_platforms.outputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |-
            DSMR_VERSION=${{ steps.dsmr_version.outputs.version }}
            DOCKER_TARGET_RELEASE=${{ steps.docker_release.outputs.release }}
