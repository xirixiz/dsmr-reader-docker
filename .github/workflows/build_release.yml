name: "DSMR: Build Docker images"

on:
  # push:
  #   branches:
  #     - development
  #     - main
  #   paths-ignore:
  #     - "**.md"
  workflow_dispatch:

concurrency:
  group: docker-build
  cancel-in-progress: true

env:
  DOCKER_TARGET_REPO: xirixiz/dsmr-reader-docker
  DOCKERFILE: Dockerfile

jobs:
  build_release:
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸš€ GitHub: Checkout repository"
        uses: actions/checkout@v4

      - name: "âš™ï¸ DSMR: Determine upstream version"
        id: dsmr_version
        shell: bash
        run: |
          set -euo pipefail

          REPO_VAR="${{ vars.DSMR_VERSION }}"
          BRANCH="${GITHUB_REF##*/}"

          echo "Branch=${BRANCH}"
          echo "Repository variable DSMR_VERSION='${REPO_VAR}'"

          # Repo variable has highest priority
          if [[ -n "${REPO_VAR}" ]]; then
            VERSION="${REPO_VAR#v}"
            echo "Using repository DSMR_VERSION=${VERSION}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Development branch uses development
          if [[ "${BRANCH}" == "development" ]]; then
            echo "Using development"
            echo "version=development" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Main (and any other) uses latest upstream release
          URL="https://api.github.com/repos/dsmrreader/dsmr-reader/releases/latest"
          VERSION="$(curl -fsSL "${URL}" | jq -r '.tag_name' | sed 's/^v//')"
          echo "Using latest upstream release=${VERSION}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: "âš™ï¸ Docker: Compute Docker build release (main only)"
        id: docker_release
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF##*/}"

          if [[ "${BRANCH}" != "main" ]]; then
            # No versioning for development, keep a stable marker
            echo "release=development" >> "$GITHUB_OUTPUT"
            echo "DOCKER_TARGET_RELEASE=development" >> "$GITHUB_ENV"
            exit 0
          fi

          DATE="$(TZ=Europe/Amsterdam date +%Y.%m.%d)"
          RUN="${GITHUB_RUN_NUMBER}"
          REL="${DATE}.${RUN}"

          echo "DOCKER_TARGET_RELEASE=${REL}"
          echo "release=${REL}" >> "$GITHUB_OUTPUT"
          echo "DOCKER_TARGET_RELEASE=${REL}" >> "$GITHUB_ENV"

      - name: "âš™ï¸ Docker: Compute tags"
        id: docker_tags
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ steps.dsmr_version.outputs.version }}"
          BRANCH="${GITHUB_REF##*/}"

          if [[ "${BRANCH}" == "development" ]]; then
            echo "tags=development" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${VERSION}" == "development" ]]; then
            echo "Main branch cannot publish 'development' as version" >&2
            exit 1
          fi

          MAJOR="$(echo "${VERSION}" | cut -d. -f1)"
          MINOR="$(echo "${VERSION}" | cut -d. -f2)"

          if [[ -z "${MAJOR}" || -z "${MINOR}" ]]; then
            echo "Version '${VERSION}' does not look like x.y.z, refusing to tag" >&2
            exit 1
          fi

          echo "tags=${VERSION},${MAJOR}.${MINOR},${MAJOR},latest" >> "$GITHUB_OUTPUT"

      - name: "âš™ï¸ Docker: Set up QEMU"
        uses: docker/setup-qemu-action@v3

      - name: "âš™ï¸ Docker: Set up Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ğŸ”“ Docker: Login (Docker Hub)"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: "ğŸ”“ Docker: Login (GHCR)"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "âš™ï¸ Docker: Metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKER_TARGET_REPO }}
            ghcr.io/${{ env.DOCKER_TARGET_REPO }}
          tags: |
            type=raw,value=${{ steps.docker_tags.outputs.tags }}

      - name: "ğŸš€ Docker: Build and push"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |-
            DSMR_VERSION=${{ steps.dsmr_version.outputs.version }}
            DOCKER_TARGET_RELEASE=${{ steps.docker_release.outputs.release }}
