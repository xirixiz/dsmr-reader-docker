#!/command/with-contenv bash
# shellcheck shell=bash
# shellcheck source=/usr/local/lib/s6-functions.sh

set -euo pipefail
IFS=$'\n\t'

. /usr/local/lib/s6-functions.sh
_load_s6_vars

#---------------------------------------------------------------------------------------------------------------------------
# HELPERS
#---------------------------------------------------------------------------------------------------------------------------
function _require_var() {
    local name="$1"
    local value="${!name:-}"

    if [[ -z "${value}" ]]; then
        _error "${CURRENT_DIR} | ${name} is not set"
        return 1
    fi
    return 0
}

function _warn_if_default() {
    local name="$1"
    local bad="$2"
    local value="${!name:-}"

    if [[ -n "${value}" && "${value}" == "${bad}" ]]; then
        _warn "${CURRENT_DIR} | Default ${name} detected, this is a security risk, please set a secure value"
    fi
}

#---------------------------------------------------------------------------------------------------------------------------
# VALIDATION: PLATFORM / MODE
#---------------------------------------------------------------------------------------------------------------------------
function _init_validate_y2038_issue() {
    local year arch
    year="$(date +%Y)"
    arch="$(uname -m)"

    if [[ "${arch}" == "armv7l" && ( "${year}" == "1969" || "${year}" == "1970" ) ]]; then
        _error "${CURRENT_DIR} | Y2038 issue detected: Your Docker host has an outdated libseccomp version. Please update libseccomp on your host system"
        return 1
    fi
    return 0
}

function _init_validate_operation_mode() {
    local mode="${CONTAINER_RUN_MODE:-standalone}"

    case "${mode}" in
        standalone|server_remote_datalogger|remote_datalogger)
            _info "${CURRENT_DIR} | Operation mode: ${mode}"
            return 0
            ;;
        *)
            _error "${CURRENT_DIR} | Invalid CONTAINER_RUN_MODE: ${mode}"
            _error "${CURRENT_DIR} | Valid options: standalone, server_remote_datalogger, remote_datalogger"
            return 1
            ;;
    esac
}

#---------------------------------------------------------------------------------------------------------------------------
# VALIDATION: REMOTE INPUT SUBCONFIG (SERIAL OR IPV4)
# Allowed in all modes, used as "remote input" settings in standalone and server modes.
#---------------------------------------------------------------------------------------------------------------------------
function _init_datalogger_mode_validate_serial_config() {
    local errors=0

    # Support both variable names
    if [[ -z "${DSMRREADER_REMOTE_DATALOGGER_SERIAL_DEVICE:-}" && -n "${DSMRREADER_REMOTE_DATALOGGER_SERIAL_PORT:-}" ]]; then
        export DSMRREADER_REMOTE_DATALOGGER_SERIAL_DEVICE="${DSMRREADER_REMOTE_DATALOGGER_SERIAL_PORT}"
    fi

    _require_var "DSMRREADER_REMOTE_DATALOGGER_SERIAL_DEVICE" || ((errors++))
    _require_var "DSMRREADER_REMOTE_DATALOGGER_SERIAL_BAUDRATE" || ((errors++))
    _require_var "DSMRREADER_REMOTE_DATALOGGER_SERIAL_BYTESIZE" || ((errors++))

    [[ "${errors}" -eq 0 ]]
}

function _init_datalogger_mode_validate_network_config() {
    local errors=0

    _require_var "DSMRREADER_REMOTE_DATALOGGER_NETWORK_HOST" || ((errors++))
    _require_var "DSMRREADER_REMOTE_DATALOGGER_NETWORK_PORT" || ((errors++))

    [[ "${errors}" -eq 0 ]]
}

function _init_datalogger_mode_validate_api_config() {
    local errors=0

    _require_var "DSMRREADER_REMOTE_DATALOGGER_API_HOSTS" || ((errors++))
    _require_var "DSMRREADER_REMOTE_DATALOGGER_API_KEYS" || ((errors++))

    [[ "${errors}" -eq 0 ]]
}

#---------------------------------------------------------------------------------------------------------------------------
# VALIDATION: VAR COMBINATIONS
# Allow DSMRREADER_REMOTE_DATALOGGER_* in standalone and server modes.
# API vars are only required for remote_datalogger (separate forwarder container).
# If API vars are set in other modes, just warn.
#---------------------------------------------------------------------------------------------------------------------------
function _init_validate_remote_vars_vs_mode() {
    local mode="${CONTAINER_RUN_MODE:-standalone}"
    local found_api=()

    while IFS='=' read -r k v; do
        [[ -z "${v}" ]] && continue
        case "${k}" in
            DSMRREADER_REMOTE_DATALOGGER_API_*)
                found_api+=("${k}")
                ;;
        esac
    done < <(env)

    if [[ "${mode}" != "remote_datalogger" && "${#found_api[@]}" -gt 0 ]]; then
        _warn "${CURRENT_DIR} | Remote datalogger API variables are set but mode is '${mode}', they will be ignored"
        _warn "${CURRENT_DIR} | Found: ${found_api[*]}"
    fi

    if [[ "${mode}" == "remote_datalogger" ]]; then
        if [[ -n "${DJANGO_DATABASE_HOST:-}${DJANGO_DATABASE_NAME:-}${DJANGO_DATABASE_USER:-}${DJANGO_DATABASE_PASSWORD:-}${DJANGO_DATABASE_PORT:-}" ]]; then
            _warn "${CURRENT_DIR} | Database variables are set but not used in remote_datalogger mode"
        fi
        if [[ -n "${DSMRREADER_ADMIN_USER:-}${DSMRREADER_ADMIN_PASSWORD:-}" ]]; then
            _warn "${CURRENT_DIR} | Admin variables are set but not used in remote_datalogger mode"
        fi
    fi

    return 0
}

#---------------------------------------------------------------------------------------------------------------------------
# VALIDATION: REQUIRED VARS (MODE BASED)
# Semantics:
# - standalone: server with DB and admin, optional remote input vars, no API required
# - server_remote_datalogger: server with DB and admin, no API required
# - remote_datalogger: separate forwarder container, API required
#---------------------------------------------------------------------------------------------------------------------------
function _init_validate_required_vars() {
    local errors=0
    local mode="${CONTAINER_RUN_MODE:-standalone}"

    case "${mode}" in
        standalone|server_remote_datalogger)
            _require_var "DSMRREADER_ADMIN_USER" || ((errors++))
            _require_var "DSMRREADER_ADMIN_PASSWORD" || ((errors++))
            _warn_if_default "DSMRREADER_ADMIN_PASSWORD" "admin"

            _require_var "DJANGO_SECRET_KEY" || ((errors++))
            _warn_if_default "DJANGO_SECRET_KEY" "dsmrreader"

            _require_var "DJANGO_DATABASE_NAME" || ((errors++))
            _require_var "DJANGO_DATABASE_HOST" || ((errors++))
            _require_var "DJANGO_DATABASE_USER" || ((errors++))
            _require_var "DJANGO_DATABASE_PASSWORD" || ((errors++))
            _warn_if_default "DJANGO_DATABASE_PASSWORD" "dsmrreader"
            _require_var "DJANGO_DATABASE_PORT" || ((errors++))

            # Optional remote input validation if user set an input method
            if [[ -n "${DSMRREADER_REMOTE_DATALOGGER_INPUT_METHOD:-}" ]]; then
                local input_method="${DSMRREADER_REMOTE_DATALOGGER_INPUT_METHOD}"
                case "${input_method}" in
                    serial)
                        _info "${CURRENT_DIR} | Remote input method: serial"
                        _init_datalogger_mode_validate_serial_config || ((errors++))
                        ;;
                    ipv4)
                        _info "${CURRENT_DIR} | Remote input method: ipv4"
                        _init_datalogger_mode_validate_network_config || ((errors++))
                        ;;
                    *)
                        _error "${CURRENT_DIR} | Invalid DSMRREADER_REMOTE_DATALOGGER_INPUT_METHOD: ${input_method}"
                        _error "${CURRENT_DIR} | Valid options: serial, ipv4"
                        ((errors++))
                        ;;
                esac
            fi
            ;;
        remote_datalogger)
            # Separate forwarder container
            _init_datalogger_mode_validate_api_config || ((errors++))

            local input_method="${DSMRREADER_REMOTE_DATALOGGER_INPUT_METHOD:-serial}"
            case "${input_method}" in
                serial)
                    _info "${CURRENT_DIR} | Remote datalogger input method: serial"
                    _init_datalogger_mode_validate_serial_config || ((errors++))
                    ;;
                ipv4)
                    _info "${CURRENT_DIR} | Remote datalogger input method: ipv4"
                    _init_datalogger_mode_validate_network_config || ((errors++))
                    ;;
                *)
                    _error "${CURRENT_DIR} | Invalid DSMRREADER_REMOTE_DATALOGGER_INPUT_METHOD: ${input_method}"
                    _error "${CURRENT_DIR} | Valid options: serial, ipv4"
                    ((errors++))
                    ;;
            esac
            ;;
        *)
            _error "${CURRENT_DIR} | Invalid CONTAINER_RUN_MODE: ${mode}"
            return 1
            ;;
    esac

    if [[ "${errors}" -gt 0 ]]; then
        _error "${CURRENT_DIR} | Missing or invalid configuration for mode: ${mode} (${errors} problem(s))"
        return 1
    fi

    return 0
}

#---------------------------------------------------------------------------------------------------------------------------
# MAIN EXECUTION
#---------------------------------------------------------------------------------------------------------------------------
function main() {
    [[ "${CONTAINER_ENABLE_DEBUG:-false}" == "true" ]] && set -x

    CURRENT_DIR="$(basename "$(dirname "$0")")"
    _info "${CURRENT_DIR} | Starting"

    _init_validate_y2038_issue || exit 1
    _init_validate_operation_mode || exit 1
    _init_validate_remote_vars_vs_mode || exit 1
    _init_validate_required_vars || exit 1

    _success "${CURRENT_DIR} | Validation complete"
}

main "$@"
