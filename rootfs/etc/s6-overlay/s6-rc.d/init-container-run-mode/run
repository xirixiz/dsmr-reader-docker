#!/command/with-contenv bash
# shellcheck shell=bash
# shellcheck source=/usr/local/lib/s6-functions.sh

set -euo pipefail
IFS=$'\n\t'

. /usr/local/lib/s6-functions.sh
_load_s6_vars

#---------------------------------------------------------------------------------------------------------------------------
# STARTMODE (no heavy validation here, init-validate already did that)
#---------------------------------------------------------------------------------------------------------------------------
function _startmode() {
    local mode="${CONTAINER_RUN_MODE:-standalone}"

    case "${mode}" in
        standalone)
            _success "${CURRENT_DIR} | Running as STANDALONE (local server + datalogger)"
            ;;
        server_remote_datalogger)
            _success "${CURRENT_DIR} | Running as SERVER REMOTE DATALOGGER (expects remote datalogger input)"
            ;;
        remote_datalogger)
            local input_method="${DSMRREADER_REMOTE_DATALOGGER_INPUT_METHOD:-serial}"
            _info "${CURRENT_DIR} | Running as REMOTE DATALOGGER (sending telegrams to server)"
            _info "${CURRENT_DIR} | Remote datalogger input method: ${input_method}"
            ;;
        *)
            # This should never happen because init-validate already checks it,
            # but keep a defensive guard.
            _error "${CURRENT_DIR} | Invalid CONTAINER_RUN_MODE: ${mode}"
            exit 1
            ;;
    esac
}

#---------------------------------------------------------------------------------------------------------------------------
# MAIN
#---------------------------------------------------------------------------------------------------------------------------
function main() {
    [[ "${CONTAINER_ENABLE_DEBUG:-false}" == "true" ]] && set -x

    CURRENT_DIR="$(basename "$(dirname "$0")")"
    _info "${CURRENT_DIR} | Starting"

    _startmode
}

main "$@"
