#!/command/with-contenv bash
# shellcheck shell=bash
# shellcheck source=/usr/local/lib/s6-functions.sh

set -euo pipefail
IFS=$'\n\t'

. /usr/local/lib/s6-functions.sh
_load_s6_vars

svc_dsmr_webinterface_start() {
    if [[ "${CONTAINER_RUN_MODE}" = "standalone" || "${CONTAINER_RUN_MODE}" = "server_remote_datalogger" ]]; then
        CURRENT_DIR="$(basename "$(pwd)")"
        _info "${CURRENT_DIR} | Starting"

        gunicorn_args=(
            dsmrreader.wsgi
            --bind unix:/run/gunicorn/dsmr_webinterface.socket
            --timeout 120
            --max-requests 5000
            --graceful-timeout 30
            --error-logfile -
        )

        if [[ "${CONTAINER_ENABLE_NGINX_ACCESS_LOGS:-false}" == "true" ]]; then
            gunicorn_args+=(--access-logfile -)
        else
            gunicorn_args+=(--access-logfile /dev/null)
        fi

        cmd=(/opt/venv/bin/gunicorn "${gunicorn_args[@]}")

        if command -v ionice >/dev/null 2>&1; then
            exec /command/s6-setuidgid app ionice -c 2 -n 6 nice -n 3 "${cmd[@]}"
        else
            exec /command/s6-setuidgid app nice -n 3 "${cmd[@]}"
        fi
    fi

    CURRENT_DIR="$(basename "$(pwd)")"
    _info "${CURRENT_DIR} | Disabled for mode ${CONTAINER_RUN_MODE}"
    exec sleep infinity
}

main() {
    [[ "${CONTAINER_ENABLE_DEBUG:-false}" == "true" ]] && set -x
    svc_dsmr_webinterface_start
}

main "$@"
